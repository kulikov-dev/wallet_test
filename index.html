<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Vataga Terminal Auth</title>
    <style>
        body { font-family: sans-serif; background: #121212; color: white; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; margin: 0; }
        .container { background: #1e1e1e; padding: 2rem; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.5); text-align: center; min-width: 320px; }
        .wallet-list { display: grid; gap: 10px; margin-top: 20px; }
        .wallet-btn { display: flex; align-items: center; background: #2b2b2b; border: 1px solid #3d3d3d; color: white; padding: 12px; border-radius: 8px; cursor: pointer; transition: 0.2s; text-align: left; width: 100%; }
        .wallet-btn:hover { background: #3d3d3d; border-color: #555; }
        .wallet-btn img { width: 32px; height: 32px; margin-right: 15px; border-radius: 4px; }
        h2 { margin-top: 0; font-weight: 400; }
        .status { margin-top: 15px; font-size: 0.9rem; color: #888; }
    </style>
</head>
<body>

<div class="container">
    <h2>Выберите кошелек</h2>
    <div id="wallets" class="wallet-list">
        </div>
    <div id="status" class="status">Ожидание выбора...</div>
</div>

<script>
    const providers = [];
    const walletList = document.getElementById('wallets');
    const statusDiv = document.getElementById('status');

	// Event on closing
	window.addEventListener('beforeunload', function (e) {
		const urlParams = new URLSearchParams(window.location.search);
		const port = urlParams.get('port');
		const state = urlParams.get('state');

		if (port && state) {
			navigator.sendBeacon(`http://localhost:${port}/api/wallet/cancel?state=${state}`);
		}
	});

    // 1. Поиск кошельков по стандарту EIP-6963
    window.addEventListener("eip6963:announceProvider", (event) => {
        const detail = event.detail;
        if (providers.some(p => p.info.uuid === detail.info.uuid)) return;
        
        providers.push(detail);
        renderButton(detail);
    });

    // Запрашиваем провайдеры у браузера
    window.dispatchEvent(new Event("eip6963:requestProvider"));

    function renderButton(wallet) {
        const btn = document.createElement('button');
        btn.className = 'wallet-btn';
        btn.innerHTML = `<img src="${wallet.info.icon}" alt="${wallet.info.name}"> <span>${wallet.info.name}</span>`;
        btn.onclick = () => handleAuth(wallet);
        walletList.appendChild(btn);
    }

    async function handleAuth(walletDetail) {
	
	
	
    const provider = walletDetail.provider;
    
    try {
        // ШАГ 1: Получаем адрес (Public Key)
        const accounts = await provider.request({ method: 'eth_requestAccounts' });
        
		
		
		  // ✅ ШАГ 1: Проверяем и переключаем на BSC (chainId 56)
        const currentChain = await provider.request({ method: 'eth_chainId' });
        const targetChain = '0x38';  // 56 в hex
        
        if (currentChain !== targetChain) {
            try {
                // Запрос на переключение сети
                await provider.request({
                    method: 'wallet_switchEthereumChain',
                    params: [{ chainId: targetChain }]
                });
            } catch (switchError) {
                // Если BSC не добавлен — добавляем
                if (switchError.code === 4902) {
                    await provider.request({
                        method: 'wallet_addEthereumChain',
                        params: [{
                            chainId: targetChain,
                            chainName: 'Binance Smart Chain',
                            rpcUrls: ['https://bsc-dataseed.binance.org/'],
                            nativeCurrency: { name: 'BNB', symbol: 'BNB', decimals: 18 },
                            blockExplorerUrls: ['https://bscscan.com']
                        }]
                    });
                } else {
                    throw switchError;
                }
            }
        }

		
		
		
		
		const userAddress = accounts[0];

        // ШАГ 2: Запрашиваем Payload у терминала
        const urlParams = new URLSearchParams(window.location.search);
        const port = urlParams.get('port') || '5050';
		const state = urlParams.get('state');
        
        // Спрашиваем у C#: "Вот адрес юзера, что ему подписать?"
        const response = await fetch(`http://localhost:${port}/api/wallet/obtain?addr=${userAddress}&state=${state}`);
        const typedData = await response.json(); 

        // ШАГ 3: Подпись
        const signature = await provider.request({
            method: 'eth_signTypedData_v4',
            params: [userAddress, typedData]
        });

        // ШАГ 4: Финальная отправка подписи в C#
        await fetch(`http://localhost:${port}/api/wallet/approve?addr=${userAddress}&state=${state}&sig=${signature}`, { mode: 'no-cors' });
        
        document.body.innerHTML = "<h2>Успешно!</h2>";
    } catch (err) {
        alert("Ошибка: " + err.message);
    }
}
</script>
</body>
</html>